---
title: "R Notebook"
output: 
  bookdown::html_document2: 
    theme: "lumen"
    code_download: true
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    df_print: paged
knit: (function(inputFile, encoding) { 
  encoding = encoding, 
  output_format = "html_document", 
  })
  rmarkdown::render(inputFile, 
  output_dir = here::here("output")) 
editor_options:
  chunk_output_type: console
---

<!-- For equations: \begin{equation} \end{equation} and then add (\#eq:XXX) just before the end -->


# Set-up
  
```{r, echo=FALSE}
knitr::opts_chunk$set(comment = NA, echo = TRUE, eval = TRUE, 
                      warning = FALSE, message = FALSE, 
                      fig.width = 6, fig.height = 4)
```



```{r, warning=FALSE, message=FALSE}
library(conflicted)
library(eurostat)
library(gets)
library(tidyverse)
library(janitor)
library(kableExtra)
library(plotly)
library(here)

conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
conflict_prefer("as.zoo.data.frame", "zoo")
conflict_prefer("select", "dplyr")
options(bitmapType = 'cairo') # for ggplotly
```

## To do
Air emissions accounts for greenhouse gases by NACE Rev. 2 activity - quarterly data (online data code: ENV_AC_AIGG_Q )
https://ec.europa.eu/eurostat/databrowser/view/ENV_AC_AIGG_Q__custom_2402841/default/line?lang=en


$$
TOTS = TOTD
$$

$$TOTS = B + Y$$

$$TOTD = CP + CO + J + A + JL$$

## Variables 

```{r, echo=FALSE}
tibble::tribble(
  ~`Code Eurostat`, ~`NAM Variable`,                                                 ~`Full Name`,
  "B1GQ",           "Y",                  "Gross domestic product at market prices",
  "B1G",          "YF",                                       "Value added, gross",
  "P6",           "A",                            "Exports of goods and services",
  "P7",           "B",                            "Imports of goods and services",
  "P5G",           "J",                                  "Gross capital formation",
  "P3",     "CP + CO",                            "Final consumption expenditure",
  "P3_S13",          "CO",      "Final consumption expenditure of general government",
  "P31_S13",            NA, "Individual consumption expenditure of general government",
  "P32_S13",            NA, "Collective consumption expenditure of general government",
  "P31_S14_S15",          "CP",        "Household and NPISH final consumption expenditure",
  "P31_S14",            NA,              "Final consumption expenditure of households",
  "P31_S15",            NA,                   "Final consumption expenditure of NPISH",
  "YA1",          "JL",            "Statistical discrepancy (production approach)",
  "YA0",          "JL",           "Statistical discrepancy (expenditure approach)",
  "YA2",          "JL",                "Statistical discrepancy (income approach)"
) %>% 
  mutate(`NAM Variable` = ifelse(is.na(`NAM Variable`),"",`NAM Variable`)) %>% 
  kable() %>% 
  kable_paper()


```



# Simple Aggregate Modelling


## Input Data
```{r}
q_GDP <- c("namq_10_gdp", # Hauptkomponenten
           "namq_10_fcs", # Konsum
           "namq_10_exi", # Exporte
           "namq_10_pe",
           "namq_10_pc",
           "namq_10_lp_ulc",
           "namq_10_a10",
           "namq_10_an6",
           "namq_10_a10_e",
           "naidq_10_gdp",
           "naidq_10_a10",
           "naidq_10_pe",
           "naidsq_10_nf_tr",

           "env_ac_aigg_q"
)
```

```{r}
geo_subset = "AT"
re_download <- TRUE
```




```{r}

if(re_download){
  overall <- tibble()
  for(var in q_GDP){
    full <- get_eurostat(id = var)
    
    full %>% 
      filter(geo == geo_subset) %>% 
      label_eurostat() -> intermed
    overall <- bind_rows(overall, intermed)
  }
  
  
  write_csv(overall,here("data/raw/eurostat_download.csv"))
} else {
  overall <- read_csv(here("data/raw/eurostat_download.csv"))
}



```

## Decisions to be made

**Which adjustment do we use?**

1 Calendar adjusted data, not seasonally adjusted data                         
2 Unadjusted data (i.e. neither seasonally adjusted nor calendar adjusted data)
3 Seasonally and calendar adjusted data   

Initially, I would have used Calendar adjusted data, not seasonally adjusted data to be able to forecast seasonal cycles as well. However, this is not available for all variables, so we now use "Seasonally and calendar adjusted data" 

```{r}
#s_adj_choice <- "Calendar adjusted data, not seasonally adjusted data"
s_adj_choice <- "Seasonally and calendar adjusted data"
```

**Which unit do we use?**

`r overall %>% distinct(unit) %>% print(n=30)`

Initially, we will use Chain linked volumes (Base year 2015) in Mio. €

```{r}
unit_choice <- "Chain linked volumes (2015), million euro"
```

<!-- Initially, we will use Current Prices in Mio. € -->

<!-- ```{r} -->
<!-- unit_choice <- "Current prices, million euro" -->
<!-- ``` -->


## Initial Plotting

```{r, echo=FALSE}
overall %>% 
  filter(s_adj == s_adj_choice, unit == unit_choice) %>% 
  ggplot(aes(x = time, y = values, color = na_item)) + 
  geom_line() + 
  facet_wrap(~na_item, scales = "free_y")+
  theme_minimal()+
  theme(legend.position = "none")
# overall %>% 
#   filter(s_adj == "Seasonally and calendar adjusted data", unit == "Chain linked volumes (2015), million euro") %>% 
#   # filter(na_item %in% c("Final consumption expenditure", "Final consumption expenditure of general government", 
#   #          "Household and NPISH final consumption expenditure")) %>% 
#   filter(grepl("expenditure",na_item, ignore.case = TRUE), !grepl("gross", na_item, ignore.case = TRUE)) %>%
```


```{r}
overall %>% 
  filter(s_adj == s_adj_choice, unit == unit_choice) %>% 
  # filter(na_item %in% c("Final consumption expenditure", "Final consumption expenditure of general government", 
  #          "Household and NPISH final consumption expenditure")) %>% 
  filter(grepl("expenditure",na_item, ignore.case = TRUE), !grepl("gross", na_item, ignore.case = TRUE)) %>% 
  select(na_item, time, values) %>% 
  
  mutate(group = case_when(na_item == "Individual consumption expenditure of general government"~"gov",
                           na_item == "Collective consumption expenditure of general government"~"gov",
                           na_item == "Final consumption expenditure of households"~"hh",
                           na_item == "Final consumption expenditure of NPISH"~"hh",
                           TRUE~na_item)) %>% 
  
  group_by(group, time) %>% 
  summarise(values= sum(values),.groups = "drop") %>% 
  
  ggplot(aes(x = time, y = values, color = group)) + 
  geom_line() + 
  #facet_wrap(~na_item, scales = "fixed")+
  theme_minimal()+
  geom_hline(aes(yintercept = 0))+
  theme(legend.position = "bottom")
```


```{r}
overall %>% 
  filter(s_adj == s_adj_choice, unit == unit_choice) %>% 
  filter(na_item %in% c("Final consumption expenditure", "Final consumption expenditure of general government",
                        "Household and NPISH final consumption expenditure")) %>%
  #filter(grepl("expenditure",na_item, ignore.case = TRUE), !grepl("gross", na_item, ignore.case = TRUE)) %>% 
  select(na_item, time, values) %>% 
  pivot_wider(id_cols = time, names_from = na_item, values_from = values) %>%
  clean_names() %>% 
  
  mutate(test = household_and_npish_final_consumption_expenditure + final_consumption_expenditure_of_general_government,
         test_diff = final_consumption_expenditure - test)  %>% 
  select(time, test, final_consumption_expenditure) %>% 
  pivot_longer(-time) %>% 
  
  ggplot(aes(x = time, y = value, color = name)) + 
  geom_line() + 
  #facet_wrap(~name, scales = "free")+
  theme_minimal()+
  geom_hline(aes(yintercept = 0))+
  theme(legend.position = "bottom") 
```

### Subsetting the right variables

```{r}
overall %>% 
  filter(s_adj == s_adj_choice) %>% 
  filter(unit == unit_choice) %>% 
  filter(na_item %in% c("Final consumption expenditure of general government",
                        #"Final consumption expenditure", 
                        "Household and NPISH final consumption expenditure",
                        "Gross domestic product at market prices",
                        "Gross capital formation",
                        "Exports of goods and services", "Imports of goods and services",
                        #"Statistical discrepancy (production approach)", 
                        #"Statistical discrepancy (income approach)",
                        "Statistical discrepancy (expenditure approach)")) %>% 
  janitor::remove_empty(which = "cols") %>% 
  distinct -> analysis_data_raw

analysis_data_raw %>% 
  ggplot(aes(x = time, y = values, color = na_item)) + 
  geom_line() + 
  facet_wrap(~na_item, scales = "free_y")+
  theme_minimal()+
  theme(legend.position = "none")

# c("Value added, gross", "Gross capital formation", "Final consumption expenditure", "Final consumption expenditure of general government", "Individual consumption expenditure of general government", "Collective consumption expenditure of general government", "Household and NPISH final consumption expenditure", "Final consumption expenditure of households", "Final consumption expenditure of NPISH", NA)
```


```{r}
# analysis_data_raw does not contain unique geo, time, na_item combination
# Imports of goods and services, 1997-07-01 appears twice

# analysis_data_raw %>%
#   filter(time == as.Date("1997-07-01") & na_item == "Imports of goods and services") %>% View()
# very similar (.9 vs .8), simply take avg
analysis_data_raw %>%
  group_by(geo, unit, s_adj, time, na_item) %>%
  summarise(values = mean(values)) -> analysis_data_raw
  

analysis_data_raw %>% 
  select(-unit, -s_adj) %>% 
  pivot_wider(id_cols = all_of(c("geo", "time")), names_from = na_item, values_from = values) %>% 
  clean_names() %>% 
  mutate(tots = gross_domestic_product_at_market_prices + imports_of_goods_and_services,
         totd = final_consumption_expenditure_of_general_government + 
           household_and_npish_final_consumption_expenditure + exports_of_goods_and_services + gross_capital_formation,
         diff = tots - totd) -> analysis_data

analysis_data %>% 
  
  pivot_longer(-c(geo,time),names_to = "na_item",values_to = "values") %>% 
  mutate(group = case_when(na_item %in% c("totd","tots")~"Aggregate",
                           na_item %in% c("diff","statistical_discrepancy_expenditure_approach")~"Discrepancy",
                           na_item %in% c("final_consumption_expenditure_of_general_government",
                                          "household_and_npish_final_consumption_expenditure",
                                          "exports_of_goods_and_services","gross_capital_formation") ~ "Demand",
                           na_item %in% c("gross_domestic_product_at_market_prices","imports_of_goods_and_services")~"Supply",
                           TRUE ~ na_item)) %>% 
  
  
  ggplot(aes(x = time, y = values, color = na_item)) + 
  geom_line(size = 1) + 
  facet_wrap(~group, scales = "free_y")+
  theme_minimal()+
  theme(legend.position = "right") + 
  geom_hline(aes(yintercept = 0))+
  scale_color_viridis_d(name = "Variable") + 
  scale_y_continuous(labels = function(x){scales::dollar(x,scale = 1/1000,suffix = " Mrd. €")}) +
  labs(x = NULL, y = NULL) + 
  theme(panel.background = element_rect(fill = NA, colour = "grey")) -> a


ggplotly(a)  
```



364 t CO2-Äquivalent je Mio. EUR
https://www.energyagency.at/fileadmin/dam/image/Presseaussendungen/PA_PDFs/2021/03_AEA_EEOE_Bundeslaendervergleich_Teil_1_Final.pdf


```{r}
co2_intensity <- 364

analysis_data %>% 
  mutate(co2 = gross_domestic_product_at_market_prices * co2_intensity) %>% 
  
  
  pivot_longer(-c(geo,time),names_to = "na_item",values_to = "values") %>% 
  mutate(group = case_when(na_item %in% c("totd","tots")~"Aggregate",
                           na_item %in% c("diff","statistical_discrepancy_expenditure_approach")~"Discrepancy",
                           na_item %in% c("final_consumption_expenditure_of_general_government",
                                          "household_and_npish_final_consumption_expenditure",
                                          "exports_of_goods_and_services","gross_capital_formation") ~ "Demand",
                           na_item %in% c("gross_domestic_product_at_market_prices","imports_of_goods_and_services")~"Supply",
                           TRUE ~ na_item)) %>% 
  
  
  ggplot(aes(x = time, y = values, color = na_item)) + 
  geom_line(size = 1) + 
  facet_wrap(~group, scales = "free_y")+
  theme_minimal()+
  theme(legend.position = "right") + 
  geom_hline(aes(yintercept = 0))+
  scale_color_viridis_d(name = "Variable") + 
  scale_y_continuous(labels = function(x){scales::dollar(x,scale = 1/1000,suffix = " Mrd. €")}) +
  labs(x = NULL, y = NULL) + 
  theme(panel.background = element_rect(fill = NA, colour = "grey")) -> a


ggplotly(a)  
```



<!-- ```{r} -->
<!-- if(saving){write_csv(overall, "Quarterly GDP Components.csv")} -->
<!-- ``` -->





```{r}
export_data %>% 
  filter(na_item == "Exports of goods") %>% select(time,values) %>% 
  arrange(time) %>% pull(values) %>% log %>% diff -> export_goods
```


```{r}
export_goods_lag <- VARselect(y = export_goods, lag.max = max.lag)$selection["SC(n)"]
```


```{r}
export_goods.model <- isat(
  y = export_goods,
  ar = if (export_goods_lag > 0) {
    1:export_goods_lag
  } else{
    NULL
  },
  plot = TRUE,
  iis = TRUE,
  sis = TRUE,
  t.pval = 0.01
)

```

## Exports


```{r}
export_data %>% 
  filter(na_item == "Exports of goods") %>% select(time,values) %>% 
  arrange(time) %>% pull(values) %>% first %>% log -> export_goods_first

export_data %>% 
  filter(na_item == "Exports of services") %>% select(time,values) %>% 
  arrange(time) %>% pull(values) %>% first %>% log -> export_services_first



export_data %>% 
  filter(na_item %in% c("Exports of goods", "Exports of services"))

tibble(,
       goods = exp(export_goods_first + (export_goods.model$mean.fit)*-1), 
       services = exp(export_services_first + (export_services.model$mean.fit)*-1))





```

```{r}
export_data %>% 
  filter(na_item %in% c("Exports of goods", "Exports of services")) %>% 
  ggplot(aes(x = time)) + 
  geom_line(aes(y = values, color = na_item)) + 
  geom_line(aes(y = ))

```



```{r}
a <- isat(export_goods, ar = if(export_goods_lag>0){1:export_goods_lag}else{NULL}, mc = TRUE, iis = TRUE, sis = TRUE, plot = TRUE)

b <- arx(export_goods, ar = if(export_goods_lag>0){1:export_goods_lag}else{NULL}, plot = TRUE)

predict.arx(a, newmxreg = rep(0,5), n.ahead = 5, plot = TRUE)
predict.arx(b, newmxreg = rep(0,5), n.ahead = 5, plot = TRUE)

```

